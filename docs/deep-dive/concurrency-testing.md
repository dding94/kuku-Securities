# ë™ì‹œì„± í…ŒìŠ¤íŠ¸ Deep Dive: ConcurrentWithdrawIntegrationTest

> **ëª©ì **: ì´ ë¬¸ì„œëŠ” ê¸ˆìœµ ì‹œìŠ¤í…œì—ì„œ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ê°€ **ì™œ** í•„ìš”í•˜ê³ , **ì–´ë–»ê²Œ** êµ¬í˜„í–ˆìœ¼ë©°, **ë¬´ì—‡ì„** ì¦ëª…í•˜ëŠ”ì§€ë¥¼ Why-Driven ë°©ì‹ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.
> ë©´ì ‘ì—ì„œ "ë™ì‹œì„± ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í–ˆë‚˜ìš”?"ë¼ëŠ” ì§ˆë¬¸ì— ìì‹  ìˆê²Œ ë‹µë³€í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## 1. Why: ì´ í…ŒìŠ¤íŠ¸ê°€ ì™œ í•„ìš”í•œê°€?

### 1.1 ê¸ˆìœµ ì‹œìŠ¤í…œì˜ ì¹˜ëª…ì  ë²„ê·¸: Race Condition

```
ì‹œë‚˜ë¦¬ì˜¤: ê³„ì¢Œ ì”ì•¡ 1,000ì›, ë‘ ì‚¬ìš©ìê°€ ë™ì‹œì— 1,000ì› ì¶œê¸ˆ ì‹œë„
```

| ì‹œê°„ | Thread A | Thread B | ì‹¤ì œ ì”ì•¡ | ë¬¸ì œ |
|------|----------|----------|-----------|------|
| T1 | ì”ì•¡ ì¡°íšŒ: 1,000ì› | - | 1,000ì› | |
| T2 | - | ì”ì•¡ ì¡°íšŒ: 1,000ì› | 1,000ì› | |
| T3 | ì”ì•¡ >= 1,000? âœ… | - | 1,000ì› | |
| T4 | - | ì”ì•¡ >= 1,000? âœ… | 1,000ì› | âš ï¸ ë‘˜ ë‹¤ í†µê³¼! |
| T5 | ì”ì•¡ = 0 ì €ì¥ | - | 0ì› | |
| T6 | - | ì”ì•¡ = 0 ì €ì¥ | 0ì› (ë˜ëŠ” ìŒìˆ˜) | ğŸ’¥ **ìŒìˆ˜ ì”ì•¡ ë˜ëŠ” ì´ˆê³¼ ì¶œê¸ˆ** |

> [!CAUTION]
> **ë²„ê·¸ì˜ í•µì‹¬**: êµ¬í˜„ ë°©ì‹ì— ë”°ë¼ ìŒìˆ˜ ì”ì•¡ ë˜ëŠ” ì´ˆê³¼ ì¶œê¸ˆ(ì¤‘ë³µ ì²˜ë¦¬)ìœ¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
> ê³µí†µì ì€ **ê³„ì¢Œì˜ ë¶ˆë³€ì‹(invariant)ì´ ê¹¨ì§„ë‹¤**ëŠ” ê²ƒì…ë‹ˆë‹¤.
> - `ì”ì•¡ - ì¶œê¸ˆì•¡` ë°©ì‹ â†’ ìŒìˆ˜ ì”ì•¡ ë°œìƒ
> - `ì”ì•¡ = 0` ë°©ì‹ â†’ ì”ì•¡ì€ 0ì´ì§€ë§Œ 2,000ì›ì´ ë¹ ì ¸ë‚˜ê°„ ê¸°ë¡ì´ ë‚¨ìŒ

**ê²°ê³¼**: ê³„ì¢Œì—ëŠ” 1,000ì›ë§Œ ìˆì—ˆì§€ë§Œ 2,000ì›ì´ ì¶œê¸ˆë¨ â†’ **ê¸ˆìœµ ì†ì‹¤ ë°œìƒ**

### 1.2 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì˜ í•œê³„

```java
// ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - í•­ìƒ ì„±ê³µ (ìˆœì°¨ ì‹¤í–‰)
@Test
void ì¶œê¸ˆ_í…ŒìŠ¤íŠ¸() {
    Balance balance = new Balance(1000);
    balance.withdraw(1000);
    assertThat(balance.getAmount()).isEqualTo(0);
}
```

**ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì˜ í•œê³„**:
- ì¼ë°˜ì ì¸ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ëŠ” **ìˆœì°¨ì **ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ Race Condition ì¬í˜„ì´ ì–´ë ¤ì›€
- ë™ì‹œì„± ë²„ê·¸ëŠ” **í™˜ê²½/íƒ€ì´ë° ì˜ì¡´ì **ì´ë¼ ì¬í˜„ì„±ì´ ë‚®ìŒ (flaky)
- DB ë½/ê²©ë¦¬ ìˆ˜ì¤€/íŠ¸ëœì­ì…˜ ê²½ê³„ê¹Œì§€ í¬í•¨í•˜ë©´ **í†µí•© í…ŒìŠ¤íŠ¸ê°€ í•„ìˆ˜**
- Threadë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ì‹¤ì œ DB íŠ¹ì„±ì„ ë°˜ì˜í•˜ì§€ ëª»í•¨

### 1.3 ì´ í…ŒìŠ¤íŠ¸ê°€ ì¦ëª…í•˜ëŠ” ê²ƒ

| ê²€ì¦ í•­ëª© | ì„¤ëª… |
|-----------|------|
| **Race Condition ë°©ì§€** | ë™ì‹œ ìš”ì²­ ì‹œ ë°ì´í„° ë¬´ê²°ì„± ìœ ì§€ |
| **ë‚™ê´€ì  ë½ ë™ì‘ í™•ì¸** | `@Version` ê¸°ë°˜ ì¶©ëŒ ê°ì§€ê°€ ì •ìƒ ì‘ë™ |
| **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì •í™•ì„±** | ì”ì•¡ ë¶€ì¡± ì‹œ ì •í™•íˆ ì˜ˆì™¸ ë°œìƒ |
| **ì›ì¥(Ledger) ì •í•©ì„±** | Transaction, JournalEntry, Balanceê°€ ì¼ê´€ëœ ìƒíƒœ ìœ ì§€ |

---

## 2. What: ë™ì‹œì„± ë¬¸ì œ í•´ê²° ì „ëµ

### 2.1 ë‚™ê´€ì  ë½ (Optimistic Locking)

ìš°ë¦¬ ì‹œìŠ¤í…œì€ **ë‚™ê´€ì  ë½**ì„ ì‚¬ìš©í•˜ì—¬ ë™ì‹œì„±ì„ ì œì–´í•©ë‹ˆë‹¤.

```java
// BalanceJpaEntity.java
@Entity
public class BalanceJpaEntity {
    
    @Version  // â† í•µì‹¬: JPAê°€ ìë™ìœ¼ë¡œ ë²„ì „ ê´€ë¦¬
    @Column(name = "version")
    private Long version;
    
    // ...
}
```

**ë™ì‘ ì›ë¦¬**:

```mermaid
sequenceDiagram
    participant A as Thread A
    participant B as Thread B
    participant DB as Database

    A->>DB: SELECT * FROM balances WHERE version=1
    B->>DB: SELECT * FROM balances WHERE version=1
    A->>DB: UPDATE balances SET amount=0, version=2 WHERE version=1
    Note over DB: âœ… ì„±ê³µ (version 1â†’2)
    B->>DB: UPDATE balances SET amount=0, version=2 WHERE version=1
    Note over DB: âŒ ì‹¤íŒ¨! (versionì´ ì´ë¯¸ 2)
    DB-->>B: ObjectOptimisticLockingFailureException
```

### 2.2 ì™œ ë‚™ê´€ì  ë½ì¸ê°€? (vs ë¹„ê´€ì  ë½)

| íŠ¹ì„± | ë‚™ê´€ì  ë½ | ë¹„ê´€ì  ë½ |
|------|-----------|-----------|
| **ë½ íšë“ ì‹œì ** | ì»¤ë°‹ ì‹œ ê²€ì¦ | ì¡°íšŒ ì‹œ ì¦‰ì‹œ ë½ |
| **ë™ì‹œì„±** | ë†’ìŒ (ë½ ëŒ€ê¸° ì—†ìŒ) | ë‚®ìŒ (ë½ ëŒ€ê¸° ë°œìƒ) |
| **ì¶©ëŒ ì‹œ** | ì˜ˆì™¸ ë°œìƒ â†’ ì¬ì‹œë„ í•„ìš” | ëŒ€ê¸° í›„ ìˆœì°¨ ì²˜ë¦¬ |
| **DB ë¶€í•˜** | ë‚®ìŒ | ë†’ìŒ (ë½ ê´€ë¦¬ ì˜¤ë²„í—¤ë“œ) |
| **ì í•©í•œ ìƒí™©** | ì¶©ëŒì´ ë“œë¬¸ ê²½ìš° | ì¶©ëŒì´ ë¹ˆë²ˆí•œ ê²½ìš° |

> [!TIP]
> **ê¸ˆìœµ ì‹œìŠ¤í…œì—ì„œ ë‚™ê´€ì  ë½ì„ ì„ íƒí•œ ì´ìœ **:
> - ëŒ€ë¶€ë¶„ì˜ ì¶œê¸ˆ ìš”ì²­ì€ ì„œë¡œ ë‹¤ë¥¸ ê³„ì¢Œì—ì„œ ë°œìƒ (ì¶©ëŒ ë“œë¬¾)
> - ê°™ì€ ê³„ì¢Œ ë™ì‹œ ì¶œê¸ˆì€ ë“œë¬¸ ì¼€ì´ìŠ¤ (ë°œìƒ ì‹œ ì¬ì‹œë„ë¡œ í•´ê²°)
> - ë†’ì€ ì²˜ë¦¬ëŸ‰(TPS) ìœ ì§€ê°€ ì¤‘ìš”

### 2.3 ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ vs ê¸°ìˆ ì  ì˜ˆì™¸

í…ŒìŠ¤íŠ¸ì—ì„œ ë‘ ê°€ì§€ "ê¸°ëŒ€ë˜ëŠ” ì‹¤íŒ¨"ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤:

```java
ConcurrencyRunner.run(2, task, 
    InsufficientBalanceException.class,        // ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸
    ObjectOptimisticLockingFailureException.class  // ê¸°ìˆ ì  ì˜ˆì™¸
);
```

| ì˜ˆì™¸ | ë°œìƒ ì¡°ê±´ | ì˜ë¯¸ |
|------|-----------|------|
| `InsufficientBalanceException` | ì”ì•¡ < ì¶œê¸ˆì•¡ | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì˜¬ë°”ë¥´ê²Œ ê±°ë¶€ |
| `ObjectOptimisticLockingFailureException` | version ì¶©ëŒ | ë™ì‹œ ìˆ˜ì • ê°ì§€ â†’ ê¸°ìˆ ì  ë³´í˜¸ ì‘ë™ |

---

## 3. How: í…ŒìŠ¤íŠ¸ êµ¬í˜„ ìƒì„¸

### 3.1 í…ŒìŠ¤íŠ¸ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ConcurrentWithdrawIntegrationTest        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ConcurrencyRunnerâ”‚  â”‚     LedgerTestFixture        â”‚ â”‚
â”‚  â”‚ (ìŠ¤ë ˆë“œ ê´€ë¦¬)    â”‚  â”‚ (ë°ì´í„° ìƒì„±/ì •ë¦¬/ê²€ì¦)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                         â†“                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              WithdrawService (í…ŒìŠ¤íŠ¸ ëŒ€ìƒ)          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ConcurrencyRunner í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜

```java
// ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì‹œì‘í•˜ë„ë¡ ë³´ì¥
CountDownLatch startLatch = new CountDownLatch(1);

for (int i = 0; i < threadCount; i++) {
    executor.submit(() -> {
        startLatch.await();  // ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì—¬ê¸°ì„œ ëŒ€ê¸°
        task.run();          // ë™ì‹œ ì‹¤í–‰!
    });
}

startLatch.countDown();  // ğŸš€ ëª¨ë“  ìŠ¤ë ˆë“œ ë™ì‹œ ì‹œì‘!
```

**ì™œ CountDownLatchì¸ê°€?**:
- ìŠ¤ë ˆë“œ ìƒì„± ì‹œê°„ ì°¨ì´ë¡œ ì¸í•œ "ìˆœì°¨ ì‹¤í–‰" ë°©ì§€
- ì§„ì •í•œ ë™ì‹œì„± ìƒí™© ì¬í˜„
- ê²½ìŸ ì¡°ê±´(Race Condition)ì„ ì˜ë„ì ìœ¼ë¡œ ìœ ë°œ

> [!NOTE]
> **Flaky í…ŒìŠ¤íŠ¸ ë°©ì§€ ì „ëµ**:
> - CountDownLatchë¥¼ ì¨ë„ ì‹¤ì œë¡œ ê²¹ì³ ì‹¤í–‰ ì•ˆ ë  ìˆ˜ ìˆìŒ (OS ìŠ¤ì¼€ì¤„ë§ ì˜ì¡´)
> - ì¶©ëŒ ì¬í˜„ì„±ì„ ë†’ì´ê¸° ìœ„í•´ `@RepeatedTest` ë˜ëŠ” loop ì‹¤í–‰ ê³ ë ¤
> - warm-up delay, barrier ê¸°ë²•ìœ¼ë¡œ ìŠ¤ë ˆë“œ ë™ê¸°í™” ê°•í™”
> - **Testcontainers(MySQL)** ì‚¬ìš©ìœ¼ë¡œ ì‹¤ì œ DB ë½/ê²©ë¦¬ íŠ¹ì„± ë°˜ì˜

### 3.3 í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì „ì•¡ ì¶œê¸ˆ ê²½ìŸ

```java
@Test
@DisplayName("ë™ì‹œì— 2ê°œ ìŠ¤ë ˆë“œê°€ ì „ì²´ ì”ì•¡ì„ ì¶œê¸ˆí•˜ë©´ í•˜ë‚˜ë§Œ ì„±ê³µí•´ì•¼ í•œë‹¤")
void ë™ì‹œ_ì „ì•¡_ì¶œê¸ˆì‹œ_í•˜ë‚˜ë§Œ_ì„±ê³µí•´ì•¼_í•œë‹¤() {
    // Given: 1000ì› ê³„ì¢Œ
    BigDecimal initialBalance = new BigDecimal("1000");
    BigDecimal withdrawAmount = new BigDecimal("1000");
    
    // When: 2ê°œ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— 1000ì› ì¶œê¸ˆ ì‹œë„
    ExecutionResult result = ConcurrencyRunner.run(2, () -> {
        withdrawService.withdraw(command);
    }, InsufficientBalanceException.class, 
       ObjectOptimisticLockingFailureException.class);
    
    // Then: ì •í™•íˆ 1ê°œë§Œ ì„±ê³µ
    assertThat(result.getSuccessCount()).isEqualTo(1);
    assertThat(result.getExpectedFailureCount()).isEqualTo(1);
    fixture.assertBalance(accountId, BigDecimal.ZERO);  // ì”ì•¡ 0ì›
}
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… 2ê°œ ì¤‘ **ì •í™•íˆ 1ê°œë§Œ** ì„±ê³µí•´ì•¼ í•¨
- âœ… ìµœì¢… ì”ì•¡ì€ **ì •í™•íˆ 0ì›**ì´ì–´ì•¼ í•¨
- âœ… ìŒìˆ˜ ì”ì•¡ì´ **ì ˆëŒ€** ë°œìƒí•˜ë©´ ì•ˆ ë¨

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ë‹¤ì¤‘ ìŠ¤ë ˆë“œ ë¶€ë¶„ ì¶œê¸ˆ

```java
@Test
@DisplayName("10ê°œ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— 100ì›ì”© ì¶œê¸ˆí•˜ë©´ ë°ì´í„° ì •í•©ì„±ì´ ìœ ì§€ë˜ì–´ì•¼ í•œë‹¤")
void ë‹¤ì¤‘_ìŠ¤ë ˆë“œ_ë™ì‹œ_ì¶œê¸ˆì‹œ_ë°ì´í„°_ì •í•©ì„±_ìœ ì§€() {
    // Given: 1000ì› ê³„ì¢Œ, 10ê°œ ìŠ¤ë ˆë“œê°€ ê° 100ì›ì”© ì¶œê¸ˆ
    // When: ë™ì‹œ ì‹¤í–‰
    // Then: ì„±ê³µ íšŸìˆ˜ Ã— 100ì› = ì°¨ê°ëœ ê¸ˆì•¡
}
```

**í•µì‹¬ ê²€ì¦ ê³µì‹**:
```
ìµœì¢… ì”ì•¡ = ì´ˆê¸° ì”ì•¡ - (ì„±ê³µ íšŸìˆ˜ Ã— ê±´ë‹¹ ê¸ˆì•¡)
```

ì´ ê³µì‹ì´ **í•­ìƒ** ì„±ë¦½í•´ì•¼ ë°ì´í„° ì •í•©ì„±ì´ ë³´ì¥ë©ë‹ˆë‹¤.

### 3.4 ì›ì¥ ì •í•©ì„± ê²€ì¦ (Financial Integrity)

```java
// LedgerTestFixture.java
public void assertLedgerConsistency(Long accountId, 
                                     int expectedSuccessCount, 
                                     BigDecimal amountPerTx) {
    // 1. Transaction ê°œìˆ˜ = ì„±ê³µ íšŸìˆ˜
    Long txCount = entityManager.createQuery(
        "SELECT COUNT(t) FROM TransactionJpaEntity t WHERE ...").getSingleResult();
    assertThat(txCount).isEqualTo(expectedSuccessCount);
    
    // 2. JournalEntry ê°œìˆ˜ = ì„±ê³µ íšŸìˆ˜ (ë‹¨ì¼ ê³„ì¢Œ ê´€ì )
    // âš ï¸ ì£¼ì˜: ì´ ê²€ì¦ì€ "1 Tx = 1 Entry" ê°€ì •
    Long journalCount = entityManager.createQuery(
        "SELECT COUNT(e) FROM JournalEntryJpaEntity e WHERE ...").getSingleResult();
    assertThat(journalCount).isEqualTo(expectedSuccessCount);
    
    // 3. JournalEntry ì´ì•¡ = ì„±ê³µ íšŸìˆ˜ Ã— ê±´ë‹¹ ê¸ˆì•¡
    BigDecimal expectedTotal = amountPerTx.multiply(new BigDecimal(expectedSuccessCount));
    BigDecimal actualTotal = entityManager.createQuery(
        "SELECT COALESCE(SUM(e.amount), 0) FROM JournalEntryJpaEntity e WHERE ...")
        .getSingleResult();
    assertThat(actualTotal).isEqualByComparingTo(expectedTotal);
}
```

> [!IMPORTANT]
> **ë³µì‹ë¶€ê¸°(Double-Entry) ê´€ì  ì£¼ì˜**:
>
> ì¼ë°˜ì ì¸ ë³µì‹ë¶€ê¸°ì—ì„œëŠ” 1ê±°ë˜ = ìµœì†Œ 2ê°œ ì—”íŠ¸ë¦¬(ì°¨ë³€/ëŒ€ë³€)ê°€ ìƒê¹ë‹ˆë‹¤.
> í˜„ì¬ êµ¬í˜„ì€ **ë‹¨ì¼ ê³„ì¢Œ ê´€ì **ìœ¼ë¡œ USER_CASH ê³„ì¢Œì˜ DEBITë§Œ ê¸°ë¡í•˜ë©°,
> ìƒëŒ€ ê³„ì¢Œ(COMPANY_CASH)ì˜ CREDITì€ ë³„ë„ ì‹œìŠ¤í…œì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
>
> **ê²€ì¦ ì „ëµ**:
> - ê°œìˆ˜ ê²€ì¦ì€ êµ¬í˜„ ë°©ì‹ì— ë”°ë¼ ë‹¤ë¦„ (`1 Tx = N Entry`)
> - **ì¬ë¬´ì  íš¨ê³¼(SUM) ê²€ì¦ì´ í•µì‹¬**: ì„±ê³µ íšŸìˆ˜ Ã— ê¸ˆì•¡ = DB ê¸°ë¡ ì´ì•¡
> - ì „ì²´ ì›ì¥ ê· í˜•(DEBIT = CREDIT across all accounts)ì€ ë³„ë„ í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ ê²€ì¦

---

## 4. ë©´ì ‘ ì˜ˆìƒ ì§ˆë¬¸ & ë‹µë³€

### Q1: "ë™ì‹œì„± ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í–ˆë‚˜ìš”?"

> **A**: JPAì˜ `@Version`ì„ í™œìš©í•œ **ë‚™ê´€ì  ë½(Optimistic Locking)**ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.
>
> 1. **ë¬¸ì œ ì •ì˜**: ê°™ì€ ê³„ì¢Œì— ë™ì‹œ ì¶œê¸ˆ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ Race Conditionì´ ë°œìƒí•˜ì—¬ ì”ì•¡ì´ ìŒìˆ˜ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> 2. **í•´ê²° ë°©ë²•**: Balance ì—”í‹°í‹°ì— `@Version` í•„ë“œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. JPAê°€ UPDATE ì‹œ `WHERE version = ?`ë¥¼ ìë™ ì¶”ê°€í•˜ì—¬, ë¨¼ì € ì»¤ë°‹í•œ íŠ¸ëœì­ì…˜ë§Œ ì„±ê³µí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” `ObjectOptimisticLockingFailureException`ì´ ë°œìƒí•©ë‹ˆë‹¤.
>
> 3. **ì™œ ë‚™ê´€ì  ë½ì¸ê°€?**: ëŒ€ë¶€ë¶„ì˜ ì¶œê¸ˆì€ ì„œë¡œ ë‹¤ë¥¸ ê³„ì¢Œì—ì„œ ë°œìƒí•˜ë¯€ë¡œ ì¶©ëŒì´ ë“œë­…ë‹ˆë‹¤. ë¹„ê´€ì  ë½ì€ ëª¨ë“  ìš”ì²­ì— ë½ ëŒ€ê¸°ê°€ ë°œìƒí•˜ì—¬ ì„±ëŠ¥ì´ ì €í•˜ë˜ì§€ë§Œ, ë‚™ê´€ì  ë½ì€ ì¶©ëŒ ì‹œì—ë§Œ ì¬ì‹œë„í•˜ë©´ ë©ë‹ˆë‹¤.

### Q2: "ì´ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ëŠ” ì–´ë–»ê²Œ ë™ì‘í•˜ë‚˜ìš”?"

> **A**: `CountDownLatch`ë¥¼ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì‹œì‘**í•˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
>
> 1. Nê°œì˜ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•˜ê³  ëª¨ë‘ `startLatch.await()`ì—ì„œ ëŒ€ê¸°ì‹œí‚µë‹ˆë‹¤.
> 2. `startLatch.countDown()`ì„ í˜¸ì¶œí•˜ë©´ ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
> 3. ê²°ê³¼ë¥¼ `ExecutionResult`ì— ìˆ˜ì§‘í•˜ì—¬ ì„±ê³µ/ì˜ˆìƒ ì‹¤íŒ¨/ì˜ˆìƒì¹˜ ëª»í•œ ì‹¤íŒ¨ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.
> 4. ìµœì¢… ìƒíƒœ(Balance, Transaction, JournalEntry)ê°€ ì •í•©ì„±ì„ ìœ ì§€í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.

### Q3: "ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ í†µí•© í…ŒìŠ¤íŠ¸ì˜ ì°¨ì´ì ì€?"

> **A**: 
> - **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: `Balance.withdraw()` ë©”ì„œë“œê°€ ì”ì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì°¨ê°í•˜ëŠ”ì§€ ê²€ì¦. ìˆœì°¨ ì‹¤í–‰.
> - **í†µí•© í…ŒìŠ¤íŠ¸**: ì‹¤ì œ DBì™€ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì‹œì„± ìƒí™©ì—ì„œ ì‹œìŠ¤í…œ ì „ì²´ê°€ ì •í•©ì„±ì„ ìœ ì§€í•˜ëŠ”ì§€ ê²€ì¦.
>
> ë™ì‹œì„± ë²„ê·¸ëŠ” ì¼ë°˜ì ì¸ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œëŠ” **ì¬í˜„ì´ ì–´ë µê³  í†µí•© í…ŒìŠ¤íŠ¸ê°€ ë” ì í•©**í•©ë‹ˆë‹¤.
> Threadë¥¼ ì‚¬ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë„ ê°€ëŠ¥í•˜ì§€ë§Œ íƒ€ì´ë° ì˜ì¡´ì ì´ë¼ flakyí•˜ê³ , DB ë½/ê²©ë¦¬/íŠ¸ëœì­ì…˜ ê²½ê³„ê¹Œì§€ í¬í•¨í•œ ê²€ì¦ì€ í†µí•© í…ŒìŠ¤íŠ¸ê°€ ë” ì‹ ë¢°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Q4: "í…ŒìŠ¤íŠ¸ì—ì„œ ì‹¤íŒ¨ê°€ 'ê¸°ëŒ€ë˜ëŠ”' ì´ìœ ëŠ”?"

> **A**: ë™ì‹œì„± í…ŒìŠ¤íŠ¸ì—ì„œ **ëª¨ë“  ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ì˜¤íˆë ¤ ë¬¸ì œ**ì…ë‹ˆë‹¤.
>
> - 2ê°œ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì „ì•¡ ì¶œê¸ˆì„ ì‹œë„í•˜ë©´, ë‹¹ì—°íˆ 1ê°œëŠ” ì‹¤íŒ¨í•´ì•¼ í•©ë‹ˆë‹¤.
> - ì‹¤íŒ¨í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ Race Condition ë°©ì§€ê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ” ê²ƒì…ë‹ˆë‹¤.
> - ìš°ë¦¬ëŠ” "ì˜¬ë°”ë¥¸ ì´ìœ ë¡œ ì‹¤íŒ¨"í•˜ëŠ”ì§€ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤:
> - `InsufficientBalanceException`: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì”ì•¡ ë¶€ì¡±ì„ ê°ì§€
> - `ObjectOptimisticLockingFailureException`: ë‚™ê´€ì  ë½ì´ ì¶©ëŒ ê°ì§€

### Q5: "í”„ë¡œë•ì…˜ì—ì„œ ì¬ì‹œë„ ë¡œì§ì€ ì–´ë–»ê²Œ êµ¬í˜„í•˜ë‚˜ìš”?"

> **A**: ì¬ì‹œë„ëŠ” **ë©±ë“±ì„±(Idempotency) ë³´ì¥ì´ ì „ì œ**ì…ë‹ˆë‹¤.
>
> **1. ë©±ë“±ì„± í‚¤ (businessRefId)**:
> ```java
> // WithdrawService.java
> if (isDuplicateTransaction(command.businessRefId())) {
>     log.warn("Duplicate transaction detected");
>     return;  // ì¤‘ë³µ ìš”ì²­ì€ ë¬´ì‹œ
> }
> ```
> - `businessRefId`ëŠ” Transaction í…Œì´ë¸”ì— **UNIQUE ì¸ë±ìŠ¤**ë¡œ ì„¤ì •
> - ì¬ì‹œë„ ì‹œì—ë„ ê°™ì€ `businessRefId`ë¥¼ ì‚¬ìš©í•˜ë©´ ì¤‘ë³µ ì €ë„ ìƒì„± ë°©ì§€
>
> **2. ì¬ì‹œë„ ë ˆì´ì–´**:
> - **Application Layer**ì—ì„œ ì¬ì‹œë„í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë¨
> - Domain LayerëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ, ì¬ì‹œë„ëŠ” ìƒìœ„ ë ˆì´ì–´ ì±…ì„
> ```java
> @Retryable(
>     value = ObjectOptimisticLockingFailureException.class,
>     maxAttempts = 3,
>     backoff = @Backoff(delay = 100, multiplier = 2, random = true)  // jitter
> )
> ```
>
> **3. Backoff/Jitter**:
> - ê³ ì • delayëŠ” "thundering herd" ë¬¸ì œ ìœ ë°œ ê°€ëŠ¥
> - `random = true` ë˜ëŠ” exponential backoffë¡œ DB ë¶€í•˜ ë¶„ì‚°
>
> í…ŒìŠ¤íŠ¸ì—ì„œëŠ” "ë‚™ê´€ì  ë½ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€"ë¥¼ ê²€ì¦í•˜ëŠ” ê²ƒì´ ëª©ì ì´ë¯€ë¡œ, ì¬ì‹œë„ëŠ” ë³„ë„ ê´€ì‹¬ì‚¬ì…ë‹ˆë‹¤.

### Q6: "OptimisticLock ì¬ì‹œë„í•˜ë©´ ì¤‘ë³µ ì €ë„ ì•ˆ ìƒê¸°ë‚˜ìš”?"

> **A**: `businessRefId` + **UNIQUE ì œì•½**ìœ¼ë¡œ ë°©ì§€í•©ë‹ˆë‹¤.
>
> 1. ì²« ì‹œë„ì—ì„œ Transactionì´ ìƒì„±ë˜ë©´, `businessRefId`ê°€ DBì— ì €ì¥ë¨
> 2. ì¬ì‹œë„ ì‹œ `isDuplicateTransaction()` ì²´í¬ë¡œ ì´ë¯¸ ì¡´ì¬í•˜ë©´ early return
> 3. DB ë ˆë²¨ì—ì„œë„ UNIQUE ì œì•½ìœ¼ë¡œ ì´ì¤‘ ë°©ì–´
>
> ```sql
> CREATE UNIQUE INDEX uk_transactions_business_ref_id 
>     ON transactions(business_ref_id);
> ```

---

## 5. í•µì‹¬ ìš”ì•½

| í•­ëª© | ë‚´ìš© |
|------|------|
| **í…ŒìŠ¤íŠ¸ ëª©ì ** | ë™ì‹œ ì¶œê¸ˆ ì‹œ Race Condition ë°©ì§€ ë° ë°ì´í„° ì •í•©ì„± ê²€ì¦ |
| **í•´ê²° ì „ëµ** | JPA @Version ê¸°ë°˜ ë‚™ê´€ì  ë½ |
| **í…ŒìŠ¤íŠ¸ ê¸°ë²•** | CountDownLatchë¡œ ë™ì‹œ ì‹œì‘ ë³´ì¥ |
| **ê²€ì¦ ëŒ€ìƒ** | Balance ì •í•©ì„±, Transaction/JournalEntry ê°œìˆ˜ ë° ì´ì•¡ |
| **ê¸°ëŒ€ ê²°ê³¼** | ì„±ê³µ + ê¸°ëŒ€ ì‹¤íŒ¨ = ì „ì²´ ìŠ¤ë ˆë“œ ìˆ˜ |

---

## 6. ì°¸ê³  ìë£Œ

- [JPA Optimistic Locking](https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#locking-optimistic)
- [Spring @Transactional Deep Dive](file:///Users/myeonggu.jung/Desktop/MG/01-ì´ì§/01-ê°œì¸í”„ë¡œì íŠ¸/kuku/docs/deep-dive/spring-transactional.md)
- [MySQL InnoDB Locking](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html)
